notifications-client-java
=========================

Java Client for the [Notifications Service](https://github.com/samfcmc/bennu-notifications). The Client is responsible for generating and sending notifications to the Notifications Service.

NOTE: This is not a consumer. The Client just creates and sends notifications. It does not "consume" them. This client stores the notifications when the notifications service is down or returns an error. It can store in memory or it can use a MySQL database. If you want to use the second option you need a MySQL server running and create a database.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [Installation](#installation)
  - [In memory storage](#in-memory-storage)
  - [Persistent storage](#persistent-storage)
- [Requirements](#requirements)
- [Usage](#usage)
  - [Configure a database](#configure-a-database)
  - [Instantiate the client](#instantiate-the-client)
    - [Using a properties file](#using-a-properties-file)
    - [Passing the needed parameters directly](#passing-the-needed-parameters-directly)
  - [Send a notification](#send-a-notification)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Installation

### In memory storage

If you just want to store all pending notifications (those that can't be handled at the moment because the server returns an error or it's down) you just need to use the `client` module as it is.

Using Maven, you need to add the dependency to your `pom.xml` file

```xml
...
<dependencies>
  <dependency>
    <groupId>org.fenixedu</groupId>
    <artifactId>bennu-notifications-client</artifactId>
    <version>1.0</version>
  </dependency>
  ...
</dependencies>
```

### Persistent storage

You can make sure that, even if the application using the client stops, you can still handle all pending notifications next time it is running. You can use the `client-ff` module that uses the [Fenix Framework](https://fenix-framework.github.io/) to store pending notifications in a MySQL database To use this client, using Maven, include the following dependency:

```xml
<dependencies>
  <dependency>
    <groupId>org.fenixedu</groupId>
    <artifactId>notifications-client-ff</artifactId>
    <version>1.0</version>
  </dependency>
  ...
</dependencies>
```

## Requirements

-	Maven
-	JDK 8

If you want to use the persistent version of the client (the one that stores pending notifications in a MySQL database) you also need a MySQL server running and a database.

## Usage

Then we need to create an instance of the `Client` class, so we can use that instance to create and send notifications.

### Configure a database

If you are using the `client` that stores pending notifications in memory you can skip this step.

Connect to your MySQL server and create a database, for instance `notifications` .

In your project that uses this client you need a file `fenix-framework.properties` at `src/main/resources`. This file should look like this:

```
dbAlias = //localhost:3306/notifications
dbUsername = root
dbPassword = root
updateRepositoryStructureIfNeeded = true
```

Change the `dbAlias`, `dbUsername` and `dbPassword` according to your database settings.

### Instantiate the client

To instantiate a client you need to use `NotificationsClientFactory` class. You can do it using one of the two possible ways. Using a properties file and passing the needed values directly.

#### Using a properties file

First, you need a file `notifications.properties` at`src/main/resources` that looks like this:

```
url       = <Url where the notifications service is running>
appId     = <application id generated by the notifications service>
appSecret = <application secret key generated by the notifications service>
```

Then, in your code, you can instantiate the client:

```java
// Using the in memory storage version
NotificationsClient client = NotificationsClientFactory.getClientFromPropertiesFile();

// Using the persistent storage version
NotificationsClient client = NotificationsClientFactory.getClientFromPropertiesFile(new NotificationsClientFFBackend());
```

If your file has a name different that `notifications.properties` you have to pass it explicitly to the `NotificationsClientFactory` :

```java
// Using the in memory storage version
NotificationsClient client = NotificationsClientFactory,getClientFromPropertiesFile("filename");

// Using the persistent storage version
NotificationsClient client = NotificationsClientFactory,getClientFromPropertiesFile("filename", new NotificationsClientFFBackend());
```

#### Passing the needed parameters directly

If you don't want to use a properties file you can pass all the parameters directly to the `NotificationsClientFactory` class:

```java
// Using the in memory storage version
NotificationsClient client = NotificationsClientFactory.getClient("url", "app Id", "app Secret");

// Using the persistent storage version
NotificationsClient client = NotificationsClientFactory.getClient("url", "app Id", "app Secret", new NotificationsClientFFBackend());
```

### Send a notification

After you have instantiated the `NotificationsClient` class you can use that instance to create and send notifications.

In order to create a notification you need to provide the username(s) of the user(s) to who you want to send notifications and the payload. The payload is just a Json object with some properties that the server stores and consumers use to show the notifications in a proper way. You don't need to know the struture of this object. We have a builder to help you create this payload in a structured way.

To create this payload you need to use `Notification.Builder` class. Here you have a full example of what to do in your code to send a notification to some users.

```java
NotificationsClient client = NotificationsClientFactory.getClientFromPropertiesFile();

String username1 = "username1";
String username2 = "username2";

Notification.Builder builder = new Notification.Builder();
build.link("link").image("url of an image").type("string type").description("EN", "description text in english").usernames("username1", "username2", ....);

// Sending a notification to multiple users
client.postNotification(builder.build());
```

The `image` and `link` attributes are optional. However, `type` and `description`, and `usernames` are mandatory. If you try to build a `NotificationPayload` object without specifying the`type`, with at least, one `description` in one language and with, at least, one username, it will raise an exception.

You can provide a description in more than one language:

```java
// Provide a description in english
builder.description("EN", "Description in english");
// Provide a description in portuguese
builder.description("PT", "Descrição em português");
```
